# WordPress Redux Framework class-redux-helpers.php 敏感信息泄漏漏洞 CVE-2021-38314

## 漏洞描述

2021年8月爆出Redux Framework存在未授权的敏感信息泄露漏洞，CVE编号为CVE-2021-38314，影响v4.2.11及以下版本，发送特定的请求包可以在未授权的情况下获取服务器敏感信息

## 漏洞影响

<a-checkbox checked>Redux Framework <= v4.2.11</a-checkbox></br>

## 插件名

<a-checkbox checked>Redux Framework</a-checkbox></br>

<a-checkbox checked>https://github.com/reduxframework/redux-framework</a-checkbox></br>

## 漏洞复现

影响范围为 v4.211 以下, 看一下版本间的更新差异

![img](/assets/PeiQi-Wiki/img/1638358475283-b0163456-8faa-479e-af3a-905badc388b3.png)

这里将 add_action 注册的函数都删除掉了，本地安装查看函数相关代码

![img](/assets/PeiQi-Wiki/img/1638358545151-4ca5c485-ec21-4151-9eb1-5f88121366f5.png)

```php
$support_hash = md5( md5( Redux_Functions_Ex::hash_key() . '-redux' ) . '-support' );
add_action( 'wp_ajax_nopriv_' . $support_hash, array( 'Redux_Helpers', 'support_args' ) );
add_action( 'wp_ajax_' . $support_hash, array( 'Redux_Helpers', 'support_args' ) );
$hash_arg = md5( trailingslashit( network_site_url() ) . '-redux' );
add_action( 'wp_ajax_nopriv_' . $hash_arg, array( 'Redux_Helpers', 'hash_arg' ) );
add_action( 'wp_ajax_' . $hash_arg, array( 'Redux_Helpers', 'hash_arg' ) );
add_action( 'wp_ajax_redux_support_hash', array( 'Redux_Functions', 'support_hash' ) );

add_filter( 'redux/tracking/options', array( 'Redux_Helpers', 'redux_stats_additions' ) );
		
```

查看 add_action 注册的函数 hash_arg() 和 support_args()

```php
public static function hash_arg() {
			echo esc_html( md5( Redux_Functions_Ex::hash_key() . '-redux' ) );
			die();
		}
public static function support_args() {
			header( 'Expires: Mon, 26 Jul 1997 05:00:00 GMT' );
			header( 'Last-Modified: ' . gmdate( 'D, d M Y H:i:s' ) . 'GMT' );
			header( 'Expires: Sat, 26 Jul 1997 05:00:00 GMT' );
			header( 'Cache-Control: no-store, no-cache, must-revalidate' );
			header( 'Cache-Control: post-check=0, pre-check=0', false );
			header( 'Pragma: no-cache' );

			$instances = Redux::all_instances();

			if ( isset( $_REQUEST['i'] ) && ! empty( $_REQUEST['i'] ) ) { // phpcs:ignore WordPress.Security.NonceVerification
				if ( is_array( $instances ) && ! empty( $instances ) ) {
					foreach ( $instances as $opt_name => $data ) {
						if ( md5( $opt_name . '-debug' ) === $_REQUEST['i'] ) { // phpcs:ignore WordPress.Security.NonceVerification
							$array = $data;
						}
					}
				}

				if ( isset( $array ) ) {

					// We only want the extension names and versions.
					$array->extensions = self::get_extensions( $opt_name );
					$to_return         = array();

					// Filter out all the unwanted data.
					foreach ( $array as $key => $value ) {
						if ( in_array(
							$key,
							array(
								// 'fields',
								'extensions',
								'sections',
								'args',
								// 'field_types'
							),
							true
						) ) {
							$to_return[ $key ] = $value;
						} else { // phpcs:ignore Generic.CodeAnalysis.EmptyStatement
							// phpcs:ignore Squiz.PHP.CommentedOutCode
							/* echo $key.PHP_EOL; */
						}
					}
					$array = $to_return;
				} else {
					die();
				}
			} else {
				$array = self::get_statistics_object();
				if ( is_array( $instances ) && ! empty( $instances ) ) {
					$array['instances'] = array();
					foreach ( $instances as $opt_name => $data ) {
						$array['instances'][] = $opt_name;
					}
				}
				$array['key'] = md5( Redux_Functions_Ex::hash_key() );
			}

			ksort( $array ); // Let's make that pretty.

			// phpcs:ignored WordPress.PHP.NoSilencedErrors, WordPress.Security.EscapeOutput
			echo @htmlspecialchars( @wp_json_encode( $array, true ), ENT_QUOTES );

			die();
		}
```

support_args() 函数 $_REQUEST['i'] 为空，来到另一处分支

```php
} else {
				$array = self::get_statistics_object();
				if ( is_array( $instances ) && ! empty( $instances ) ) {
					$array['instances'] = array();
					foreach ( $instances as $opt_name => $data ) {
						$array['instances'][] = $opt_name;
					}
				}
				$array['key'] = md5( Redux_Functions_Ex::hash_key() );
			}
```

跟踪 get_statistics_object() 函数，该函数可以获取 插件等环境变量 信息

![img](/assets/PeiQi-Wiki/img/1638359149546-75d4de8a-6f46-4d3e-8f92-c47bd8a7cde9.png)

回过头可以看到该函数 为 wp_ajax_nopriv_* 可未授权调用![img](/assets/PeiQi-Wiki/img/1638359228666-d7471f78-4f4f-488c-b2b1-b3269826ff23.png)

其中需要变量 $support_hash, 跟踪 hash_key() 方法

```php
$support_hash = md5( md5( Redux_Functions_Ex::hash_key() . '-redux' ) . '-support' );
```

![img](/assets/PeiQi-Wiki/img/1638359410443-576b0779-e7ac-4b1e-9ed7-a26d816ec901.png)

wp-config.php 中存在 AUTH_KEY 参数，为随机值

![img](/assets/PeiQi-Wiki/img/1638359556051-2f9feee9-5d5f-4fbd-af1c-d0a322ad2ecb.png)

这里回到 hash_arg() 函数![img](/assets/PeiQi-Wiki/img/1638359592601-dd97e7ca-9254-4fa2-86d5-d2a0e6d2b12a.png)

```php
public static function hash_arg() {
			echo esc_html( md5( Redux_Functions_Ex::hash_key() . '-redux' ) );
			die();
		}
```

这里就调用到了 Redux_Functions_Ex::hash_key()  中的函数，且返回 md5值

回到刚刚的代码中，可以发现得到的结果同样也是 $support_hash 我们所需要知道的参数，下面为等价替换

```php
$support_hash = md5(hash_arg(). '-support' );
```

![img](/assets/PeiQi-Wiki/img/1638359717951-f9720604-06ae-4534-be09-893963ff4755.png)

这样我们就获取到了一个利用链

```php
$hash_arg = md5( trailingslashit( network_site_url() ) . '-redux' );
add_action( 'wp_ajax_nopriv_' . $hash_arg, array( 'Redux_Helpers', 'hash_arg' ) );
|
获取 md5( Redux_Functions_Ex::hash_key() . '-redux') 值
|
$support_hash = md5( md5( Redux_Functions_Ex::hash_key() . '-redux' ) . '-support' );
add_action( 'wp_ajax_nopriv_' . $support_hash, array( 'Redux_Helpers', 'support_args' ) );
|
调用函数 support_args 获取系统敏感信息
```

![img](/assets/PeiQi-Wiki/img/1638360218832-e2bb91a5-5137-4d6e-a3fb-177f65600c03.png)

![img](/assets/PeiQi-Wiki/img/1638360235551-e45ff7c2-f987-4c6b-bf86-6549dbaa3e4a.png)

![img](/assets/PeiQi-Wiki/img/1638361768796-da5d9bf6-9f58-45cb-970b-6ad711be2e10.png)

![img](/assets/PeiQi-Wiki/img/1638361791092-a64fbe22-da88-43c7-a934-3f6ee397bf90.png)

成功获取到了插件版本等有关信息