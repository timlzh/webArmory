WDJA CMS 1.5.2模板注入漏洞 漏洞发掘分析 前言 这是年初无聊在家审的一个小众的CMS，漏洞官方已经修复，现在分享出来给大家，希望一起共同学习和进步。 代码审计 `漏洞文件：\common\incfiles\function.inc.php` 全局搜索中发现这个cms的模板引擎是使用eval来实现的。 ![img](WDJACMS1.5.2模板注入漏洞/1576941887696.png) 我们 跟进`ii_eval()`函数。非常这里`$strers`可控疑似存在代码执行。我们在继续跟进`ii_eval()`看谁调用了他。 ![img](WDJACMS1.5.2模板注入漏洞/15769419845118.png) `漏洞文件：\common\incfiles\function.inc.php` 只有一个地方对他进行了调用，他是`ii_creplace()`函数 ![img](WDJACMS1.5.2模板注入漏洞/15769420731387.png) 我们看`ii_creplace()`代码，`$strers`可控，但是它必须匹配`({\$=(.[^\}]*)})`这个正则类似于下面： `{$=phpinfo()}` ![img](WDJACMS1.5.2模板注入漏洞/15769423583552.png) `漏洞文件passport\address\common\incfiles\manage_config.inc.php` 那么我们继续跟进`ii_creplace()`函数看谁对他进行了调用，找了很多但是都对函数中的`$`进行了转义，但是在`passport\address\common\incfiles\manage_config.inc.php`中的`wdja_cms_admin_manage_list()`并未做任何过滤。我们继续跟进。 ![img](WDJACMS1.5.2模板注入漏洞/15769426132007.png) 我们发现`\passport\address\manage.php`对`passport\address\common\incfiles\manage_config.inc.php`进行了包含并调用了`wdja_cms_admin_manage_action()`,而它调用了`wdja_cms_admin_manage_list()`,那么很明显我们只需将符合`{\$=(.[^\}]*)}`正则的payload传入即可导致getshell. ![img](WDJACMS1.5.2模板注入漏洞/15769428105956.png) 那么从哪传入呢，我们直接把`wdja_cms_admin_manage_list()`中的sql语句打印出来即可知道。 ![img](WDJACMS1.5.2模板注入漏洞/15769430952853.png) ![img](WDJACMS1.5.2模板注入漏洞/15769431224043.png) 很明显是从用户地址中获取。 ![image-20191221234802438](WDJACMS1.5.2模板注入漏洞/image-20191221234802438.png) Getshell 先注册一个会员 `http://www.域名.com/passport/?type=register` 在添加地址出写入要注入的命令,确认添加地址即可。 `http://www.域名.com/passport/address/index.php?type=list` ![img](WDJACMS1.5.2模板注入漏洞/15769412265912.png) ![img](WDJACMS1.5.2模板注入漏洞/15769412702349.png) getshell exp,同样方法在地址出写入下面代码即可在`passport\address`路径下生成一个shell.php ![http://goodcheerleung.gitee.io/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20201102133040.png](WDJACMS1.5.2模板注入漏洞/微信图片_20201102133040.png) ![img](WDJACMS1.5.2模板注入漏洞/15769414579686.png) ![img](WDJACMS1.5.2模板注入漏洞/15769415518386.png)

[本主题由 村长CZ 于 2020-11-17 18:53 添加图章 100元奖金](https://bbs.ichunqiu.com/forum.php?mod=misc&action=viewthreadmod&tid=59066)